(()=>{"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(e,n){for(var o=0;o<n.length;o++){var r=n[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(void 0,i=function(e,n){if("object"!==t(e)||null===e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var r=o.call(e,"string");if("object"!==t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(r.key),"symbol"===t(i)?i:String(i)),r)}var i}var n=function(){function t(e){var n=e.openErrorPopup,o=e.addInitText,r=e.dropEditor;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._inputElement=document.querySelector(".promo__upload-btn"),this._editorContainer=document.querySelector(".editor"),this._spinner=document.querySelector(".promo-spinner"),this._fileUrl,this.openErrorPopup=n,this.addInitText=o,this.dropEditor=r}var n,o;return n=t,(o=[{key:"_checkFileType",value:function(t){return!(!t||!["image/png","image/jpeg","image/jpg","image/svg+xml"].includes(t.type))}},{key:"_handleFileUpload",value:function(t){var e=this,n=t.target.files[0],o=this._checkFileType(n);this._spinner.classList.add("page__spinner_active"),o?(this._fileUrl=window.URL.createObjectURL(n),this._renderImg(this._fileUrl),this._editorContainer.classList.add("editor_active"),setTimeout((function(){e._spinner.classList.remove("page__spinner_active"),e._editorContainer.scrollIntoView({behavior:"smooth",block:"start"})}),300),this.addInitText()):(this.openErrorPopup(),this._spinner.classList.remove("page__spinner_active"))}},{key:"_renderImg",value:function(t){var e=document.querySelector(".editor__img");e&&e.remove();var n=document.createElement("img");n.classList.add("editor__img"),n.src=t,document.querySelector(".editor__img-container").appendChild(n)}},{key:"setEventListeners",value:function(){var t=this;this._inputElement.addEventListener("change",(function(e){t.dropEditor(),t._handleFileUpload(e)}))}}])&&e(n.prototype,o),Object.defineProperty(n,"prototype",{writable:!1}),t}();function o(t){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o(t)}function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,(void 0,i=function(t,e){if("object"!==o(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!==o(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(r.key),"symbol"===o(i)?i:String(i)),r)}var i}var i=function(){function t(e,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._popupSelector=e,this._closeBtnSelector=n,this.closePopup=this.closePopup.bind(this),this._handleOverlayClose=this._handleOverlayClose.bind(this),this._handleEscClose=this._handleEscClose.bind(this),this._pageElement=document.querySelector(".page")}var e,n;return e=t,(n=[{key:"openPopup",value:function(){this._popupSelector.classList.add("popup_opened"),document.addEventListener("mousedown",this._handleOverlayClose),document.addEventListener("keydown",this._handleEscClose)}},{key:"closePopup",value:function(){this._popupSelector.classList.remove("popup_opened"),document.removeEventListener("mousedown",this._handleOverlayClose),document.removeEventListener("keydown",this._handleEscClose)}},{key:"_handleEscClose",value:function(t){var e=document.querySelector(".popup_opened");"Escape"===t.key&&this.closePopup(e)}},{key:"_handleOverlayClose",value:function(t){var e=document.querySelector(".popup_opened");t.target.classList.contains("popup_opened")&&this.closePopup(e)}},{key:"setEventListeners",value:function(){this._closeBtnSelector.addEventListener("click",this.closePopup)}}])&&r(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function a(t){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a(t)}function s(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function l(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?s(Object(n),!0).forEach((function(e){c(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function c(t,e,n){return(e=d(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function u(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,d(o.key),o)}}function d(t){var e=function(t,e){if("object"!==a(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,"string");if("object"!==a(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===a(e)?e:String(e)}var f=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._inputElement=document.querySelector(".promo__upload-btn"),this._inputs=document.querySelectorAll(".editor__input"),this._labels=document.querySelectorAll(".editor__label"),this._text=document.querySelector(".editor__text"),this._textElements=document.querySelectorAll(".editor__text"),this._toolbar=document.querySelector(".editor__toolbar"),this._deleteBtn=document.querySelector(".editor__delete-btn"),this._textContainer=document.querySelector(".editor__text-container"),this._addBtn=document.querySelector(".editor__add-btn"),this._activeInput,this._activeText,this._textStyleArray=[],this._initInputsValue={fontSize:"50px",color:"#ffffff",fontWeight:400,fontStyle:"normal",textDecoration:"none",backgroundColor:"none"},this._checkedInputsValue={fontWeight:600,fontStyle:"italic",textDecoration:"underline"},this._draggedElement=null,this._offsetX,this._offsetY,this._textDefaultHeight=64}var e,n;return e=t,(n=[{key:"getTextList",value:function(){return this._textStyleArray}},{key:"_closeActiveInput",value:function(t){this._activeInput&&t.target!==this._activeInput&&this._activeInput.classList.remove("editor__input_active")}},{key:"_hideToolBar",value:function(){this._toolbar.classList.remove("editor__toolbar_active"),this._activeText.classList.remove("editor__text_focused"),this._activeText}},{key:"_dropActiveInputs",value:function(){var t=this;this._activeText&&this._activeText.classList.remove("editor__text_focused"),Array.from(this._labels).forEach((function(e){e.classList.remove("editor__label_active"),t._initInputsValue[e.control.name]&&(e.control.value=t._initInputsValue[e.control.name])}))}},{key:"_showToolBar",value:function(t){var e=this;this._dropActiveInputs();var n=t.target;this._activeText=n,this._toolbar.classList.add("editor__toolbar_active");var o=this._textStyleArray.find((function(t){return t.textElement===n}));if(o){var r=function(t){if("textElement"===t)return 1;var n=Array.from(e._inputs).find((function(e){return e.name===t}));if("checkbox"===n.type)n.value!=o[t]&&(n.labels[0].classList.add("editor__label_active"),n.checked=!0);else{var r="fontSize"===n.name?parseInt(o[t]):o[t];n.value=r}};for(var i in o)r(i)}}},{key:"_removeText",value:function(){this._activeText.remove()}},{key:"_handleTextStyleChange",value:function(t,e,n){var o=this,r=this._textStyleArray.find((function(t){return t.textElement===o._activeText})),i=e;if("checkbox"===n&&(i=r&&r[t]&&r[t]!==this._initInputsValue[t]?this._initInputsValue[t]:this._checkedInputsValue[t]),"fontSize"===t&&(i=e+"px"),this._activeText.style[t]=i,r)r[t]=i;else{var a=c({textElement:this._activeText},t,i);this._textStyleArray.push(a)}}},{key:"addText",value:function(t){this._textElements=Array.from(document.querySelectorAll(".editor__text"));var e=this._textElements.map((function(t){return t.offsetHeight})),n=e.reduce((function(t,e){return t+e}),0),o=this._getLowestText(this._textElements);if(this._textContainer.offsetHeight>n+this._textDefaultHeight||0===this._textElements.length){var r=document.createElement("div");r.textContent="Введите текст",r.classList.add("editor__text"),r.setAttribute("role","textbox"),r.setAttribute("contenteditable","true"),o?o.offsetTop+o.offsetHeight+this._textDefaultHeight>this._textContainer.offsetHeight?r.style.top=o.offsetTop-o.offsetHeight+"px":r.style.top=o.offsetTop+o.offsetHeight+"px":r.style.top="0px",t.appendChild(r),this._addBtn.classList.remove("editor__add-btn_inactive");var i=this._initInputsValue;this._textStyleArray.push(l(l({},i),{},{textElement:r}))}else this._addBtn.classList.add("editor__add-btn_inactive")}},{key:"_getLowestText",value:function(t){var e=t[0];return t.forEach((function(t){t.offsetTop>e.offsetTop&&(e=t)})),e}},{key:"dropEditor",value:function(){this._activeInput,this._activeText,this._textStyleArray=[],this._draggedElement=null,this._offsetX,this._offsetY,this._textElements=Array.from(document.querySelectorAll(".editor__text")),this._textElements&&this._textElements.forEach((function(t){t.remove()})),this._textElements=""}},{key:"setEventListeners",value:function(){var t=this;document.addEventListener("click",(function(e){t._closeActiveInput(e),t._activeText&&e.target!==t._activeText&&!t._toolbar.contains(e.target)&&t._hideToolBar(e)})),this._labels.forEach((function(e){e.addEventListener("click",(function(n){e.control.classList.contains("editor__input_active")&&"checkbox"!==e.control.type?(n.preventDefault(),e.control.classList.remove("editor__input_active"),t._activeInput=""):(t._closeActiveInput(n),e.control.classList.add("editor__input_active"),"checkbox"===e.control.type&&e.classList.toggle("editor__label_active"),t._activeInput=e.control)}))})),this._toolbar.addEventListener("click",(function(e){e.stopPropagation(),t._activeText.classList.add("editor__text_focused")})),this._inputs.forEach((function(e){e.addEventListener("input",(function(){t._handleTextStyleChange(e.name,e.value,e.type)}))})),this._textContainer.addEventListener("click",(function(e){e.target.classList.contains("editor__text")&&t._showToolBar(e)})),this._deleteBtn.addEventListener("click",(function(){t._removeText(),t._hideToolBar()})),this._addBtn.addEventListener("click",(function(){t.addText(t._textContainer)})),this._textContainer.addEventListener("mousedown",(function(e){if(e.target.classList.contains("editor__text")){t._draggedElement=e.target;var n=t._draggedElement.getBoundingClientRect().top,o=t._draggedElement.getBoundingClientRect().left;t._offsetY=e.clientY-n+n-e.target.offsetTop,t._offsetX=e.clientX-o+o-e.target.offsetLeft,t._draggedElement.classList.add("editor__text_grabbed")}})),this._textContainer.addEventListener("mousemove",(function(e){if(t._draggedElement){var n=e.clientX-t._offsetX,o=e.clientY-t._offsetY;t._draggedElement.style.left=n+"px",t._draggedElement.style.top=o+"px"}})),this._textContainer.addEventListener("mouseup",(function(){t._draggedElement&&t._draggedElement.classList.remove("editor__text_grabbed"),t._draggedElement=null}))}}])&&u(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function p(t){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p(t)}function _(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,(void 0,r=function(t,e){if("object"!==p(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,"string");if("object"!==p(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(o.key),"symbol"===p(r)?r:String(r)),o)}var r}var h=function(){function t(e){var n=e.getTextList,o=e.showSnackbar;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._downloadBtn=document.querySelector(".editor__download-btn"),this.getTextList=n,this.showSnackbar=o}var e,n;return e=t,(n=[{key:"_createCanvas",value:function(){var t=this,e=document.querySelector(".editor__img"),n=new Image(e.width,e.height);n.src=e.src,n.onload=function(){var e=n.width,o=n.height,r=document.createElement("canvas"),i=r.getContext("2d");r.width=e,r.height=o,i.drawImage(n,0,0,e,o),t.getTextList().forEach((function(n){t._addTextData(i,n,e)}));var a=r.toDataURL();t._downloadImg(a),t.showSnackbar()}}},{key:"_addTextData",value:function(t,e,n){var o=parseFloat(e.fontSize),r=parseFloat(getComputedStyle(e.textElement).paddingLeft),i=2*parseFloat(getComputedStyle(e.textElement).paddingTop),a=1.15*o,s=e.textElement.offsetLeft+r,l=e.textElement.offsetTop+o;t.font="".concat(e.fontStyle," ").concat(e.fontWeight," ").concat(e.fontSize," 'Noto Sans Display'");var c=e.textElement.textContent,u=this._wrapText(t,c,s,l,n,a,e.textElement.offsetLeft);u.forEach((function(s){if("none"!==e.backgroundColor){t.fillStyle=e.backgroundColor;var l=u.length>1?n:t.measureText(s[0]).width+r,c=a+i;t.fillRect(s[1]-r,s[2]-o,l,c)}t.fillStyle=e.color,t.fillText(s[0],s[1],s[2]),"underline"===e.textDecoration&&(t.beginPath(),t.moveTo(s[1],s[2]+5),t.lineTo(s[1]+t.measureText(s[0]).width-10,s[2]+5),t.strokeStyle=e.color,t.lineWidth=2,t.stroke())}))}},{key:"_wrapText",value:function(t,e,n,o,r,i,a){for(var s=e.split(" "),l="",c="",u=[],d=0;d<s.length;d++)c+="".concat(s[d]," "),t.measureText(c).width+a>r&&d>0?(u.push([l,n,o]),o+=i,l="".concat(s[d]," "),c="".concat(s[d]," ")):l+="".concat(s[d]," "),d===s.length-1&&u.push([l,n,o]);return u}},{key:"_downloadImg",value:function(t){var e=document.createElement("a");e.href=t,e.download="meme.png",e.click()}},{key:"setEventListeners",value:function(){var t=this;this._downloadBtn.addEventListener("click",(function(){t._createCanvas()}))}}])&&_(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),t}(),v=document.querySelector(".error-popup"),m=document.querySelector(".download-popup"),y=v.querySelector(".page__snackbar-close-btn"),b=m.querySelector(".page__snackbar-close-btn"),g=document.querySelector(".editor__text-container"),x=new i(v,y),E=new i(m,b),S=new f,w=new n({openErrorPopup:function(){return x.openPopup()},addInitText:function(){return S.addText(g)},dropEditor:function(){return S.dropEditor()}}),L=new h({getTextList:function(){return S.getTextList()},showSnackbar:function(){return E.openPopup()}});x.setEventListeners(),E.setEventListeners(),w.setEventListeners(),S.setEventListeners(),L.setEventListeners()})();